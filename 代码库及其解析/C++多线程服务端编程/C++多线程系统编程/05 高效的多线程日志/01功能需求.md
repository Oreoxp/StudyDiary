# 功能需求

​		常规的通用日志库如 log4j/logback 通常会提供丰富的功能，但这些功能不一定全都是必需的。

1. 日志消息有多种级别 ( level ), 如 TRACE、 DEBUG、 INFO、 WARN、ERROR、 FATAL 等。
2. 日志消息可能有多个目的地 ( appender)，如文件、socket、 SMTP等。
3. 日志消息的格式可配置 ( layout ), 例如 org. apache . log4j . PatternLayout。
4. 可以设置运行时过滤器 ( filter ) , 控制不同组件的日志消息的级别和目的地。

​        以本地文件为日志的destination,那么日志文件的滚动( rolling )是必需的，这样可以简化日志归档( archive)的实现。rolling的条件通常有两个:文件大小(例如每写满1GB就换下一个文件)和时间(例如每天零点新建-一个日志文件，不论前一个文件有没有写满)。muduo日志库的LogFile会自动根据文件大小和时间来主动滚动日志文件。既然能主动rolling，自然也就不必支持SIGUSR1了，毕竟多线程程序处理signal很麻烦( S4.10 )。

​		一个典型的日志文件的文件名如下:

​		logfile_ test. 2012060-144022. hostname.3605. log

​		文件名由以下几部分组成:

- 第1部分logfile_ .test 是进程的名字。通常是main()函数参数中argv[0]的basename(3)，这样容易区分究竟是哪个服务程序的日志。必要时还可以把程序版本加进去。
- 第2部分是文件的创建时间(GMT时区)。这样很容易通过文件名来选择某一时间范围内的日志，例如用通配符*.20120603-14*表示2012年6月3日下午2 点(GMT)左右的日志文件(s)。
- 第3部分是机器名称。这样即便把日志文件拷贝到别的机器上也能追溯其来源。
- 第4部分是进程id。如果-一个程序- -秒之内反复重启，那么每次都会生成不同的日志文件，参考S9.4。
- 第5部分是统一的后缀名.log。同样是为了便于周边配套脚本的编写。

​        往文件写日志的一个常见问题是，万一程序崩溃，那么最后若干条日志往往就丢失了，因为日志库不能每条消息都 flush 硬盘，更不能每条日志都 open/close 文件，这样性能开销太大。

​		muduo 日志库用两个办法来应对这一点，<u>其一是定期 ( 默认 3 秒 ) 将缓冲区内的日志消息 flush 到硬盘</u> ; <u>其二是每条内存中的日志消息都带有 cookie (或者叫哨兵值/sentry )，其值为某个函数的地址，这样通过在 core dump 文件中查找 cookie 就能找到尚未来得及写入磁盘的消息。</u>



















