#### 多路复用与多路分解

​		在本节中，我们讨论运输层的多路复用与多路分解，也就是将由网络层提供的<u>主机到主机交付服务</u>延伸到为<u>运行在主机上的应用程序提供进程到进程的交付服务</u>。为了使讨论 具体起见，我们将在因特网环境中讨论这种基本的运输层服务。然而，需要强调的是，多路复用与多路分解服务是所有计算机网络都需要的。

​		在目的主机，运输层从紧邻其下的网络层接收报文段。运输层负责将这些报文段中的数据交付给在主机上运行的适当应用程序进程。我们来看一个例子。假定你正坐在计算机前下载Web页面，同时还在运行一个FTP会话和两个Telnet会话。这样你就有4个网络应用进程在运行，即两个Telnet进程，一个FTP进程和一个HTTP进程。当你的计算机中的运输层从底层的网络层接收数据时，它需要将所接收到的数据定向到这4个进程中的一 个。现在我们来研究这是怎样完成的。

​		首先回想2. 7节的内容，一个进程（作为网络应用的一部分）有一个或多个**套接字（socket）**,它相当于从网络向进程传递数据和从进程向网络传递数据的门户。因此，如 图3-2所示，在接收主机中的运输层实际上并没有直接将数据交付给进程，而是将数据交给了一个中间的套接字。由于在任一时刻，在接收主机上可能有不止一个套接字，所以每个套接字都有唯一的标识符。标识符的格式取决于它是UDP还是TCP套接字，我们将很快对它们进行讨论。

![02多路复用与多路分解](.\markdownImage\02多路复用与多路分解.png)

​	现在我们考虑接收主机怎样将一个到达的运输层报文段定向到适当的套接字。为此目的，每个运输层报文段中具有几个字段。在接收端，运输层检査这些字段，标识出接收套接字，进而将报文段定向到该套接字。将运输层报文段中的数据交付到正确的套接字的工作称为**多路分解（demultiplexing)**。在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息（这将在以后用于分解）从而生成报文段，然后将报文段传递到网络层，所有这些工作称为**多路复用（multiplexing)**。

​		值得注意的是，图3-2中的中间那台主机的运输层必须将从其下的网络层收到的报文段分解后交给其上的P1或P2进程；这一过程是通过将到达的报文段数据定向到对应进程的套接字来完成的。中间主机中的运输层也必须收集从这些套接字输出的数据，形成运输层报文段，然后将其向下传递给网络层。尽管我们在因特网运输层协议的环境下引人了多路复用和多路分解，认识到下列事实是重要 的：它们与在某层（在运输层或别处）的单一协议何时被位于接下来的较高层的多个协议使用有关。

​		为了说明分解的工作过程，可以再以前面一节的家庭进行类比。每一个孩子通过他们 的名字来标识。

<u>			当Bill从邮递员处收到一批信件，并通过査看收信人名字而将信件亲手交付给他的兄弟姐妹们时，他执行的就是一个分解操作</u>。

<u>			当Ann从兄弟姐妹们那里收集信件并将它们交给邮递员时，她执行的就是一个多路复用操作。</u>

​		既然我们理解了运输层多路复用与多路分解的作用，那就再来看看在主机中它们实际是怎样工作的。通过上述讨论，我们知道运输层多路复用要求：

​	①套接字有唯一标识符； ②每个报文段有特殊字段来指示该报文段所要交付到的套接字。

​		如图3-3所示，

- 这些特殊字段是**源端口号字段（source port number field)**和**目的端口号字段（destination port number field)** 。( UDP 报文段和 TCP 报文段还有其他的一些字段，这些将在本章后继几节中进行讨论。）

- 端口号是一个16比特的数，其大小在0 ~ 65535之 间。0~ 1023范围的端口号称为**周知端口号（well-known port number)**,是受限制的，这是指它们保留给诸如HTTP (它使 用端口号80)和FTP (它使用端口号21)之类的周知应用层协议来使用。周知端口的列表在RFC 1700中给出，同时在http://www.iana. wg上有更新文档[RFC 3232]。当我们开发 一个新的应用程序时（如在2. 7节中开发的一个应用程序），必须为其分配一个端口号。

![02运输层报文段中的源与目的端口字段](.\markdownImage\02运输层报文段中的源与目的端口字段.png)



​		现在应该清楚运输层是怎样能够实现分解服务的了 ：在主机上的每个套接字能够分配 一个端口号，当报文段到达主机时，<u>运输层检查报文段中的目的端口号</u>，<u>并将其定向到相应的套接字</u>。然后报文段中的数据通过套接字进入其所连接的进程。如我们将看到的那样，UDP基本上是这样做的。然而，也将如我们所见，TCP中的多路复用与多路分解更为复杂。

1. ##### 无连接的多路复用与多路分解

2. 7.1节讲过，在主机上运行的Python程序使用下面一行代码创建了一个UDP套接字：

   ```python
   clientSocket * socket(socket.AF_INET, socket.SOCK_DGRAM)
   ```

​        当用这种方式创建一个UDP套接字时，运输层自动地为该套接字分配一个端U号。 特别是，运输层从范围1024 ~65535内分配一个端口号，该端口号是当前未被该主机中任 何其他UDP端口使用的号。另外一种方法是，在创建一个套接字后，我们能够在Python 程序中增加一行代码，通过套接字bind()方法为这个UDP套接字关联一个特定的端口号 (如 19157):

```python
clientSocket.bind(('', 19157))
```

